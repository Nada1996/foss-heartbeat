{"url": "https://api.github.com/repos/rails-girls-summer-of-code/rgsoc-teams/pulls/comments/36724959", "pull_request_review_id": null, "id": 36724959, "diff_hunk": "@@ -17,18 +17,23 @@ def user_emails\n \n   def users\n     return @users if @users\n-    @users = User.joins(:teams, :roles).where(roles: { name: roles })\n-    if group.to_sym == :selected_teams\n-      @users = @users.where(teams: { kind: Team::KINDS })\n-    elsif group.to_sym == :unselected_teams\n-      @users = @users.where(teams: { kind: nil })\n-    end\n-    if seasons.any?\n-      @users = @users.where(teams: {\n-        season: Season.where(name: seasons).pluck(:id)\n-      })\n-    end\n-    @users.uniq\n+    @users = User.joins(:roles).where(roles: { name: roles })\n+    @users = @users.where('roles.team_id IN (?) OR roles.name IN (?)', teams, teamless_roles) if filter_by_teams?\n+    @users = @users.uniq\n+    @users\n+  end\n+\n+  def filter_by_teams?\n+    group.to_sym != :everyone || seasons.any?\n+  end\n+\n+  def teams\n+    return @teams if @teams\n+    @teams = Team\n+    @teams = @teams.where(kind: group.to_sym == :selected_teams ? Team::KINDS : nil) if group.to_sym != :everyone", "path": "app/models/recipients.rb", "position": 29, "original_position": 29, "commit_id": "a9d9f273c7130e558e266340e3106857b021a555", "original_commit_id": "a9d9f273c7130e558e266340e3106857b021a555", "user": {"login": "marcgreenstock", "id": 287739, "avatar_url": "https://avatars2.githubusercontent.com/u/287739?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marcgreenstock", "html_url": "https://github.com/marcgreenstock", "followers_url": "https://api.github.com/users/marcgreenstock/followers", "following_url": "https://api.github.com/users/marcgreenstock/following{/other_user}", "gists_url": "https://api.github.com/users/marcgreenstock/gists{/gist_id}", "starred_url": "https://api.github.com/users/marcgreenstock/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marcgreenstock/subscriptions", "organizations_url": "https://api.github.com/users/marcgreenstock/orgs", "repos_url": "https://api.github.com/users/marcgreenstock/repos", "events_url": "https://api.github.com/users/marcgreenstock/events{/privacy}", "received_events_url": "https://api.github.com/users/marcgreenstock/received_events", "type": "User", "site_admin": false}, "body": "So this is a little tricky to understand, it took me a while too.\n\nThere are a number of filters, `group`, `seasons` and `to`.\n\nIf `group` is `:selected_teams` it will select any team that has a `kind` that is included in `Team::KINDS`, otherwise select where `kind` is specifically `nil`. `group: :everyone` will select every team.\n\nIt gets more tricky with [line 21](https://github.com/rails-girls-summer-of-code/rgsoc-teams/pull/298/files#diff-875df54ccb6e747fd165f1ebcf5d3266R21)\n\n``` ruby\n@users = @users.where('roles.team_id IN (?) OR roles.name IN (?)', teams, teamless_roles) if filter_by_teams?\n```\n\nwhere if we need to filter by team it selects users who's role belongs to a team or users who's roles is teamless (organizer developer helpdesk) and has been included in the `to` filter.\n\nI have considered rewriting the spec for `recipients.rb`, it sort of needs it because there are a lot of permutations that are not considered in the spec.\n", "created_at": "2015-08-11T09:05:27Z", "updated_at": "2015-08-11T09:05:27Z", "html_url": "https://github.com/rails-girls-summer-of-code/rgsoc-teams/pull/298#discussion_r36724959", "pull_request_url": "https://api.github.com/repos/rails-girls-summer-of-code/rgsoc-teams/pulls/298", "author_association": "MEMBER", "_links": {"self": {"href": "https://api.github.com/repos/rails-girls-summer-of-code/rgsoc-teams/pulls/comments/36724959"}, "html": {"href": "https://github.com/rails-girls-summer-of-code/rgsoc-teams/pull/298#discussion_r36724959"}, "pull_request": {"href": "https://api.github.com/repos/rails-girls-summer-of-code/rgsoc-teams/pulls/298"}}, "body_html": "<p>So this is a little tricky to understand, it took me a while too.</p>\n<p>There are a number of filters, <code>group</code>, <code>seasons</code> and <code>to</code>.</p>\n<p>If <code>group</code> is <code>:selected_teams</code> it will select any team that has a <code>kind</code> that is included in <code>Team::KINDS</code>, otherwise select where <code>kind</code> is specifically <code>nil</code>. <code>group: :everyone</code> will select every team.</p>\n<p>It gets more tricky with <a href=\"https://github.com/rails-girls-summer-of-code/rgsoc-teams/pull/298/files#diff-875df54ccb6e747fd165f1ebcf5d3266R21\">line 21</a></p>\n<div class=\"highlight highlight-source-ruby\"><pre><span class=\"pl-smi\">@users</span> <span class=\"pl-k\">=</span> <span class=\"pl-smi\">@users</span>.where(<span class=\"pl-s\"><span class=\"pl-pds\">'</span>roles.team_id IN (?) OR roles.name IN (?)<span class=\"pl-pds\">'</span></span>, teams, teamless_roles) <span class=\"pl-k\">if</span> filter_by_teams?</pre></div>\n<p>where if we need to filter by team it selects users who's role belongs to a team or users who's roles is teamless (organizer developer helpdesk) and has been included in the <code>to</code> filter.</p>\n<p>I have considered rewriting the spec for <code>recipients.rb</code>, it sort of needs it because there are a lot of permutations that are not considered in the spec.</p>", "body_text": "So this is a little tricky to understand, it took me a while too.\nThere are a number of filters, group, seasons and to.\nIf group is :selected_teams it will select any team that has a kind that is included in Team::KINDS, otherwise select where kind is specifically nil. group: :everyone will select every team.\nIt gets more tricky with line 21\n@users = @users.where('roles.team_id IN (?) OR roles.name IN (?)', teams, teamless_roles) if filter_by_teams?\nwhere if we need to filter by team it selects users who's role belongs to a team or users who's roles is teamless (organizer developer helpdesk) and has been included in the to filter.\nI have considered rewriting the spec for recipients.rb, it sort of needs it because there are a lot of permutations that are not considered in the spec."}